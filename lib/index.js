'use strict';

var _typeof2 = require('babel-runtime/helpers/typeof');

var _typeof3 = _interopRequireDefault(_typeof2);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var extend = require('extend');
var isArray = require('util').isArray;
var isDate = require('util').isDate;
var sprintf = require("sprintf-js").sprintf;
var events = require('events');
var except = require('except');

var strftime = require('./strftime');

var translationScope = 'counterpart';

function isString(val) {
  return typeof val === 'string' || Object.prototype.toString.call(val) === '[object String]';
}

function isFunction(val) {
  return typeof val === 'function' || Object.prototype.toString.call(val) === '[object Function]';
}

function isPlainObject(val) {
  //Deal with older browsers (IE8) that don't return [object Null] in this case.
  if (val === null) {
    return false;
  }
  return Object.prototype.toString.call(val) === '[object Object]';
}

function isSymbol(key) {
  return isString(key) && key[0] === ':';
}

function hasOwnProp(obj, key) {
  return Object.prototype.hasOwnProperty.call(obj, key);
}

function getEntry(translations, keys) {
  return keys.reduce(function (result, key) {
    if (isPlainObject(result) && hasOwnProp(result, key)) {
      return result[key];
    } else {
      return null;
    }
  }, translations);
}

function Counterpart() {
  this._registry = {
    locale: 'en',
    interpolate: true,
    fallbackLocales: [],
    scope: null,
    translations: {},
    interpolations: {},
    normalizedKeys: {},
    separator: '.',
    keepTrailingDot: false,
    keyTransformer: function keyTransformer(key) {
      return key;
    }
  };

  this.registerTranslations('en', require('./locales/en'));
  this.setMaxListeners(0);
}

extend(Counterpart.prototype, events.EventEmitter.prototype);

Counterpart.prototype.getLocale = function () {
  return this._registry.locale;
};

Counterpart.prototype.setLocale = function (value) {
  var previous = this._registry.locale;

  if (previous != value) {
    this._registry.locale = value;
    this.emit('localechange', value, previous);
  }

  return previous;
};

Counterpart.prototype.getFallbackLocale = function () {
  return this._registry.fallbackLocales;
};

Counterpart.prototype.setFallbackLocale = function (value) {
  var previous = this._registry.fallbackLocales;
  this._registry.fallbackLocales = [].concat(value || []);
  return previous;
};

Counterpart.prototype.getAvailableLocales = function () {
  return this._registry.availableLocales || (0, _keys2.default)(this._registry.translations);
};

Counterpart.prototype.setAvailableLocales = function (value) {
  var previous = this.getAvailableLocales();
  this._registry.availableLocales = value;
  return previous;
};

Counterpart.prototype.getSeparator = function () {
  return this._registry.separator;
};

Counterpart.prototype.setSeparator = function (value) {
  var previous = this._registry.separator;
  this._registry.separator = value;
  return previous;
};

Counterpart.prototype.setInterpolate = function (value) {
  var previous = this._registry.interpolate;
  this._registry.interpolate = value;
  return previous;
};

Counterpart.prototype.getInterpolate = function () {
  return this._registry.interpolate;
};

Counterpart.prototype.setKeyTransformer = function (value) {
  var previous = this._registry.keyTransformer;
  this._registry.keyTransformer = value;
  return previous;
};

Counterpart.prototype.getKeyTransformer = function () {
  return this._registry.keyTransformer;
};

Counterpart.prototype.registerTranslations = function (locale, data) {
  var translations = {};
  translations[locale] = data;
  extend(true, this._registry.translations, translations);
  return translations;
};

Counterpart.prototype.registerInterpolations = function (data) {
  return extend(true, this._registry.interpolations, data);
};

Counterpart.prototype.onLocaleChange = Counterpart.prototype.addLocaleChangeListener = function (callback) {
  this.addListener('localechange', callback);
};

Counterpart.prototype.offLocaleChange = Counterpart.prototype.removeLocaleChangeListener = function (callback) {
  this.removeListener('localechange', callback);
};

Counterpart.prototype.onTranslationNotFound = Counterpart.prototype.addTranslationNotFoundListener = function (callback) {
  this.addListener('translationnotfound', callback);
};

Counterpart.prototype.offTranslationNotFound = Counterpart.prototype.removeTranslationNotFoundListener = function (callback) {
  this.removeListener('translationnotfound', callback);
};

Counterpart.prototype.translate = function (key, options) {
  if (!isArray(key) && !isString(key) || !key.length) {
    throw new Error('invalid argument: key');
  }

  if (isSymbol(key)) {
    key = key.substr(1);
  }

  key = this._registry.keyTransformer(key, options);

  options = extend(true, {}, options);

  var locale = options.locale || this._registry.locale;
  delete options.locale;

  var scope = options.scope || this._registry.scope;
  delete options.scope;

  var separator = options.separator || this._registry.separator;
  delete options.separator;

  var fallbackLocales = [].concat(options.fallbackLocale || this._registry.fallbackLocales);
  delete options.fallbackLocale;

  var keys = this._normalizeKeys(locale, scope, key, separator);

  var entry = getEntry(this._registry.translations, keys);

  if (entry === null && options.fallback) {
    this.emit('translationnotfound', locale, key, options.fallback, scope);
    entry = this._fallback(locale, scope, key, options.fallback, options);
  }

  if (entry === null && fallbackLocales.length > 0 && fallbackLocales.indexOf(locale) === -1) {
    for (var ix in fallbackLocales) {
      var fallbackLocale = fallbackLocales[ix];
      var fallbackKeys = this._normalizeKeys(fallbackLocale, scope, key, separator);
      entry = getEntry(this._registry.translations, fallbackKeys);

      if (entry) {
        locale = fallbackLocale;
        break;
      }
    }
  }

  if (entry === null) {
    entry = 'missing translation: ' + keys.join(separator);
  }

  entry = this._pluralize(locale, entry, options.count);

  if (this._registry.interpolate !== false && options.interpolate !== false) {
    entry = this._interpolate(entry, options);
  }

  return entry;
};

Counterpart.prototype.localize = function (object, options) {
  if (!isDate(object)) {
    throw new Error('invalid argument: object must be a date');
  }

  options = extend(true, {}, options);

  var locale = options.locale || this._registry.locale;
  var scope = options.scope || translationScope;
  var type = options.type || 'datetime';
  var format = options.format || 'default';

  options = { locale: locale, scope: scope, interpolate: false };
  format = this.translate(['formats', type, format], extend(true, {}, options));

  return strftime(object, format, this.translate('names', options));
};

Counterpart.prototype._pluralize = function (locale, entry, count) {
  if ((typeof entry === 'undefined' ? 'undefined' : (0, _typeof3.default)(entry)) !== 'object' || entry === null || typeof count !== 'number') {
    return entry;
  }

  var pluralizeFunc = this.translate('pluralize', { locale: locale, scope: translationScope });

  if (Object.prototype.toString.call(pluralizeFunc) !== '[object Function]') {
    return pluralizeFunc;
  }

  return pluralizeFunc(entry, count);
};

Counterpart.prototype.withLocale = function (locale, callback, context) {
  var previous = this._registry.locale;
  this._registry.locale = locale;
  var result = callback.call(context);
  this._registry.locale = previous;
  return result;
};

Counterpart.prototype.withScope = function (scope, callback, context) {
  var previous = this._registry.scope;
  this._registry.scope = scope;
  var result = callback.call(context);
  this._registry.scope = previous;
  return result;
};

Counterpart.prototype.withSeparator = function (separator, callback, context) {
  var previous = this.setSeparator(separator);
  var result = callback.call(context);
  this.setSeparator(previous);
  return result;
};

Counterpart.prototype._normalizeKeys = function (locale, scope, key, separator) {
  var keys = [];

  keys = keys.concat(this._normalizeKey(locale, separator));
  keys = keys.concat(this._normalizeKey(scope, separator));
  keys = keys.concat(this._normalizeKey(key, separator));

  return keys;
};

Counterpart.prototype._normalizeKey = function (key, separator) {
  this._registry.normalizedKeys[separator] = this._registry.normalizedKeys[separator] || {};

  this._registry.normalizedKeys[separator][key] = this._registry.normalizedKeys[separator][key] || function (key) {
    if (isArray(key)) {
      var normalizedKeyArray = key.map(function (k) {
        return this._normalizeKey(k, separator);
      }.bind(this));

      return [].concat.apply([], normalizedKeyArray);
    } else {
      if (typeof key === 'undefined' || key === null) {
        return [];
      }

      var keys = key.split(separator);

      for (var i = keys.length - 1; i >= 0; i--) {
        if (keys[i] === '') {
          keys.splice(i, 1);

          if (this._registry.keepTrailingDot === true && i == keys.length) {
            keys[keys.length - 1] += '' + separator;
          }
        }
      }

      return keys;
    }
  }.bind(this)(key);

  return this._registry.normalizedKeys[separator][key];
};

Counterpart.prototype._interpolate = function (entry, values) {
  if (typeof entry !== 'string') {
    return entry;
  }

  return sprintf(entry, extend({}, this._registry.interpolations, values));
};

Counterpart.prototype._resolve = function (locale, scope, object, subject, options) {
  options = options || {};

  if (options.resolve === false) {
    return subject;
  }

  var result;

  if (isSymbol(subject)) {
    result = this.translate(subject, extend({}, options, { locale: locale, scope: scope }));
  } else if (isFunction(subject)) {
    var dateOrTime;

    if (options.object) {
      dateOrTime = options.object;
      delete options.object;
    } else {
      dateOrTime = object;
    }

    result = this._resolve(locale, scope, object, subject(dateOrTime, options));
  } else {
    result = subject;
  }

  return (/^missing translation:/.test(result) ? null : result
  );
};

Counterpart.prototype._fallback = function (locale, scope, object, subject, options) {
  options = except(options, 'fallback');

  if (isArray(subject)) {
    for (var i = 0, ii = subject.length; i < ii; i++) {
      var result = this._resolve(locale, scope, object, subject[i], options);

      if (result) {
        return result;
      }
    }

    return null;
  } else {
    return this._resolve(locale, scope, object, subject, options);
  }
};

var instance = new Counterpart();

function translate() {
  return instance.translate.apply(instance, arguments);
}

extend(translate, instance, {
  Instance: Counterpart,
  Translator: Counterpart
});

module.exports = translate;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJleHRlbmQiLCJyZXF1aXJlIiwiaXNBcnJheSIsImlzRGF0ZSIsInNwcmludGYiLCJldmVudHMiLCJleGNlcHQiLCJzdHJmdGltZSIsInRyYW5zbGF0aW9uU2NvcGUiLCJpc1N0cmluZyIsInZhbCIsIk9iamVjdCIsInByb3RvdHlwZSIsInRvU3RyaW5nIiwiY2FsbCIsImlzRnVuY3Rpb24iLCJpc1BsYWluT2JqZWN0IiwiaXNTeW1ib2wiLCJrZXkiLCJoYXNPd25Qcm9wIiwib2JqIiwiaGFzT3duUHJvcGVydHkiLCJnZXRFbnRyeSIsInRyYW5zbGF0aW9ucyIsImtleXMiLCJyZWR1Y2UiLCJyZXN1bHQiLCJDb3VudGVycGFydCIsIl9yZWdpc3RyeSIsImxvY2FsZSIsImludGVycG9sYXRlIiwiZmFsbGJhY2tMb2NhbGVzIiwic2NvcGUiLCJpbnRlcnBvbGF0aW9ucyIsIm5vcm1hbGl6ZWRLZXlzIiwic2VwYXJhdG9yIiwia2VlcFRyYWlsaW5nRG90Iiwia2V5VHJhbnNmb3JtZXIiLCJyZWdpc3RlclRyYW5zbGF0aW9ucyIsInNldE1heExpc3RlbmVycyIsIkV2ZW50RW1pdHRlciIsImdldExvY2FsZSIsInNldExvY2FsZSIsInZhbHVlIiwicHJldmlvdXMiLCJlbWl0IiwiZ2V0RmFsbGJhY2tMb2NhbGUiLCJzZXRGYWxsYmFja0xvY2FsZSIsImNvbmNhdCIsImdldEF2YWlsYWJsZUxvY2FsZXMiLCJhdmFpbGFibGVMb2NhbGVzIiwic2V0QXZhaWxhYmxlTG9jYWxlcyIsImdldFNlcGFyYXRvciIsInNldFNlcGFyYXRvciIsInNldEludGVycG9sYXRlIiwiZ2V0SW50ZXJwb2xhdGUiLCJzZXRLZXlUcmFuc2Zvcm1lciIsImdldEtleVRyYW5zZm9ybWVyIiwiZGF0YSIsInJlZ2lzdGVySW50ZXJwb2xhdGlvbnMiLCJvbkxvY2FsZUNoYW5nZSIsImFkZExvY2FsZUNoYW5nZUxpc3RlbmVyIiwiY2FsbGJhY2siLCJhZGRMaXN0ZW5lciIsIm9mZkxvY2FsZUNoYW5nZSIsInJlbW92ZUxvY2FsZUNoYW5nZUxpc3RlbmVyIiwicmVtb3ZlTGlzdGVuZXIiLCJvblRyYW5zbGF0aW9uTm90Rm91bmQiLCJhZGRUcmFuc2xhdGlvbk5vdEZvdW5kTGlzdGVuZXIiLCJvZmZUcmFuc2xhdGlvbk5vdEZvdW5kIiwicmVtb3ZlVHJhbnNsYXRpb25Ob3RGb3VuZExpc3RlbmVyIiwidHJhbnNsYXRlIiwib3B0aW9ucyIsImxlbmd0aCIsIkVycm9yIiwic3Vic3RyIiwiZmFsbGJhY2tMb2NhbGUiLCJfbm9ybWFsaXplS2V5cyIsImVudHJ5IiwiZmFsbGJhY2siLCJfZmFsbGJhY2siLCJpbmRleE9mIiwiaXgiLCJmYWxsYmFja0tleXMiLCJqb2luIiwiX3BsdXJhbGl6ZSIsImNvdW50IiwiX2ludGVycG9sYXRlIiwibG9jYWxpemUiLCJvYmplY3QiLCJ0eXBlIiwiZm9ybWF0IiwicGx1cmFsaXplRnVuYyIsIndpdGhMb2NhbGUiLCJjb250ZXh0Iiwid2l0aFNjb3BlIiwid2l0aFNlcGFyYXRvciIsIl9ub3JtYWxpemVLZXkiLCJub3JtYWxpemVkS2V5QXJyYXkiLCJtYXAiLCJrIiwiYmluZCIsImFwcGx5Iiwic3BsaXQiLCJpIiwic3BsaWNlIiwidmFsdWVzIiwiX3Jlc29sdmUiLCJzdWJqZWN0IiwicmVzb2x2ZSIsImRhdGVPclRpbWUiLCJ0ZXN0IiwiaWkiLCJpbnN0YW5jZSIsImFyZ3VtZW50cyIsIkluc3RhbmNlIiwiVHJhbnNsYXRvciIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7QUFFQSxJQUFJQSxTQUFVQyxRQUFRLFFBQVIsQ0FBZDtBQUNBLElBQUlDLFVBQVVELFFBQVEsTUFBUixFQUFnQkMsT0FBOUI7QUFDQSxJQUFJQyxTQUFVRixRQUFRLE1BQVIsRUFBZ0JFLE1BQTlCO0FBQ0EsSUFBSUMsVUFBVUgsUUFBUSxZQUFSLEVBQXNCRyxPQUFwQztBQUNBLElBQUlDLFNBQVVKLFFB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RixRQUFMLENBQWM5RSxNQUFkLEVBQXNCRyxLQUF0QixFQUE2QnlELE1BQTdCLEVBQXFDbUIsUUFBUUosQ0FBUixDQUFyQyxFQUFpRGhDLE9BQWpELENBQWI7O0FBRUEsVUFBSTlDLE1BQUosRUFBWTtBQUNWLGVBQU9BLE1BQVA7QUFDRDtBQUNGOztBQUVELFdBQU8sSUFBUDtBQUNELEdBVkQsTUFVTztBQUNMLFdBQU8sS0FBS2lGLFFBQUwsQ0FBYzlFLE1BQWQsRUFBc0JHLEtBQXRCLEVBQTZCeUQsTUFBN0IsRUFBcUNtQixPQUFyQyxFQUE4Q3BDLE9BQTlDLENBQVA7QUFDRDtBQUNGLENBaEJEOztBQWtCQSxJQUFJeUMsV0FBVyxJQUFJdEYsV0FBSixFQUFmOztBQUVBLFNBQVM0QyxTQUFULEdBQXFCO0FBQ25CLFNBQU8wQyxTQUFTMUMsU0FBVCxDQUFtQitCLEtBQW5CLENBQXlCVyxRQUF6QixFQUFtQ0MsU0FBbkMsQ0FBUDtBQUNEOztBQUVEbEgsT0FBT3VFLFNBQVAsRUFBa0IwQyxRQUFsQixFQUE0QjtBQUMxQkUsWUFBVXhGLFdBRGdCO0FBRTFCeUYsY0FBWXpGO0FBRmMsQ0FBNUI7O0FBS0EwRixPQUFPQyxPQUFQLEdBQWlCL0MsU0FBakIiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG52YXIgZXh0ZW5kICA9IHJlcXVpcmUoJ2V4dGVuZCcpO1xyXG52YXIgaXNBcnJheSA9IHJlcXVpcmUoJ3V0aWwnKS5pc0FycmF5O1xyXG52YXIgaXNEYXRlICA9IHJlcXVpcmUoJ3V0aWwnKS5pc0RhdGU7XHJcbnZhciBzcHJpbnRmID0gcmVxdWlyZShcInNwcmludGYtanNcIikuc3ByaW50ZjtcclxudmFyIGV2ZW50cyAgPSByZXF1aXJlKCdldmVudHMnKTtcclxudmFyIGV4Y2VwdCAgPSByZXF1aXJlKCdleGNlcHQnKTtcclxuXHJcbnZhciBzdHJmdGltZSA9IHJlcXVpcmUoJy4vc3RyZnRpbWUnKTtcclxuXHJcbnZhciB0cmFuc2xhdGlvblNjb3BlID0gJ2NvdW50ZXJwYXJ0JztcclxuXHJcbmZ1bmN0aW9uIGlzU3RyaW5nKHZhbCkge1xyXG4gIHJldHVybiB0eXBlb2YgdmFsID09PSAnc3RyaW5nJyB8fCBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwodmFsKSA9PT0gJ1tvYmplY3QgU3RyaW5nXSc7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzRnVuY3Rpb24odmFsKSB7XHJcbiAgcmV0dXJuIHR5cGVvZiB2YWwgPT09ICdmdW5jdGlvbicgfHwgT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbCkgPT09ICdbb2JqZWN0IEZ1bmN0aW9uXSc7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzUGxhaW5PYmplY3QodmFsKSB7XHJcbiAgLy9EZWFsIHdpdGggb2xkZXIgYnJvd3NlcnMgKElFOCkgdGhhdCBkb24ndCByZXR1cm4gW29iamVjdCBOdWxsXSBpbiB0aGlzIGNhc2UuXHJcbiAgaWYgKHZhbCA9PT0gbnVsbCkge1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuICByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbCkgPT09ICdbb2JqZWN0IE9iamVjdF0nO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc1N5bWJvbChrZXkpIHtcclxuICByZXR1cm4gaXNTdHJpbmcoa2V5KSAmJiBrZXlbMF0gPT09ICc6JztcclxufVxyXG5cclxuZnVuY3Rpb24gaGFzT3duUHJvcChvYmosIGtleSkge1xyXG4gIHJldHVybiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwob2JqLCBrZXkpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRFbnRyeSh0cmFuc2xhdGlvbnMsIGtleXMpIHtcclxuICByZXR1cm4ga2V5cy5yZWR1Y2UoZnVuY3Rpb24ocmVzdWx0LCBrZXkpIHtcclxuICAgIGlmIChpc1BsYWluT2JqZWN0KHJlc3VsdCkgJiYgaGFzT3duUHJvcChyZXN1bHQsIGtleSkpIHtcclxuICAgICAgcmV0dXJuIHJlc3VsdFtrZXldO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgfSwgdHJhbnNsYXRpb25zKTtcclxufVxyXG5cclxuZnVuY3Rpb24gQ291bnRlcnBhcnQoKSB7XHJcbiAgdGhpcy5fcmVnaXN0cnkgPSB7XHJcbiAgICBsb2NhbGU6ICdlbicsXHJcbiAgICBpbnRlcnBvbGF0ZTogdHJ1ZSxcclxuICAgIGZhbGxiYWNrTG9jYWxlczogW10sXHJcbiAgICBzY29wZTogbnVsbCxcclxuICAgIHRyYW5zbGF0aW9uczoge30sXHJcbiAgICBpbnRlcnBvbGF0aW9uczoge30sXHJcbiAgICBub3JtYWxpemVkS2V5czoge30sXHJcbiAgICBzZXBhcmF0b3I6ICcuJyxcclxuICAgIGtlZXBUcmFpbGluZ0RvdDogZmFsc2UsXHJcbiAgICBrZXlUcmFuc2Zvcm1lcjogZnVuY3Rpb24oa2V5KSB7IHJldHVybiBrZXk7IH1cclxuICB9O1xyXG5cclxuICB0aGlzLnJlZ2lzdGVyVHJhbnNsYXRpb25zKCdlbicsIHJlcXVpcmUoJy4vbG9jYWxlcy9lbicpKTtcclxuICB0aGlzLnNldE1heExpc3RlbmVycygwKTtcclxufVxyXG5cclxuZXh0ZW5kKENvdW50ZXJwYXJ0LnByb3RvdHlwZSwgZXZlbnRzLkV2ZW50RW1pdHRlci5wcm90b3R5cGUpO1xyXG5cclxuQ291bnRlcnBhcnQucHJvdG90eXBlLmdldExvY2FsZSA9IGZ1bmN0aW9uKCkge1xyXG4gIHJldHVybiB0aGlzLl9yZWdpc3RyeS5sb2NhbGU7XHJcbn07XHJcblxyXG5Db3VudGVycGFydC5wcm90b3R5cGUuc2V0TG9jYWxlID0gZnVuY3Rpb24odmFsdWUpIHtcclxuICB2YXIgcHJldmlvdXMgPSB0aGlzLl9yZWdpc3RyeS5sb2NhbGU7XHJcblxyXG4gIGlmIChwcmV2aW91cyAhPSB2YWx1ZSkge1xyXG4gICAgdGhpcy5fcmVnaXN0cnkubG9jYWxlID0gdmFsdWU7XHJcbiAgICB0aGlzLmVtaXQoJ2xvY2FsZWNoYW5nZScsIHZhbHVlLCBwcmV2aW91cyk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gcHJldmlvdXM7XHJcbn07XHJcblxyXG5Db3VudGVycGFydC5wcm90b3R5cGUuZ2V0RmFsbGJhY2tMb2NhbGUgPSBmdW5jdGlvbigpIHtcclxuICByZXR1cm4gdGhpcy5fcmVnaXN0cnkuZmFsbGJhY2tMb2NhbGVzO1xyXG59O1xyXG5cclxuQ291bnRlcnBhcnQucHJvdG90eXBlLnNldEZhbGxiYWNrTG9jYWxlID0gZnVuY3Rpb24odmFsdWUpIHtcclxuICB2YXIgcHJldmlvdXMgPSB0aGlzLl9yZWdpc3RyeS5mYWxsYmFja0xvY2FsZXM7XHJcbiAgdGhpcy5fcmVnaXN0cnkuZmFsbGJhY2tMb2NhbGVzID0gW10uY29uY2F0KHZhbHVlIHx8IFtdKTtcclxuICByZXR1cm4gcHJldmlvdXM7XHJcbn07XHJcblxyXG5Db3VudGVycGFydC5wcm90b3R5cGUuZ2V0QXZhaWxhYmxlTG9jYWxlcyA9IGZ1bmN0aW9uKCkge1xyXG4gIHJldHVybiB0aGlzLl9yZWdpc3RyeS5hdmFpbGFibGVMb2NhbGVzIHx8IE9iamVjdC5rZXlzKHRoaXMuX3JlZ2lzdHJ5LnRyYW5zbGF0aW9ucyk7XHJcbn07XHJcblxyXG5Db3VudGVycGFydC5wcm90b3R5cGUuc2V0QXZhaWxhYmxlTG9jYWxlcyA9IGZ1bmN0aW9uKHZhbHVlKSB7XHJcbiAgdmFyIHByZXZpb3VzID0gdGhpcy5nZXRBdmFpbGFibGVMb2NhbGVzKCk7XHJcbiAgdGhpcy5fcmVnaXN0cnkuYXZhaWxhYmxlTG9jYWxlcyA9IHZhbHVlO1xyXG4gIHJldHVybiBwcmV2aW91cztcclxufTtcclxuXHJcbkNvdW50ZXJwYXJ0LnByb3RvdHlwZS5nZXRTZXBhcmF0b3IgPSBmdW5jdGlvbigpIHtcclxuICByZXR1cm4gdGhpcy5fcmVnaXN0cnkuc2VwYXJhdG9yO1xyXG59O1xyXG5cclxuQ291bnRlcnBhcnQucHJvdG90eXBlLnNldFNlcGFyYXRvciA9IGZ1bmN0aW9uKHZhbHVlKSB7XHJcbiAgdmFyIHByZXZpb3VzID0gdGhpcy5fcmVnaXN0cnkuc2VwYXJhdG9yO1xyXG4gIHRoaXMuX3JlZ2lzdHJ5LnNlcGFyYXRvciA9IHZhbHVlO1xyXG4gIHJldHVybiBwcmV2aW91cztcclxufTtcclxuXHJcbkNvdW50ZXJwYXJ0LnByb3RvdHlwZS5zZXRJbnRlcnBvbGF0ZSA9IGZ1bmN0aW9uKHZhbHVlKSB7XHJcbiAgdmFyIHByZXZpb3VzID0gdGhpcy5fcmVnaXN0cnkuaW50ZXJwb2xhdGU7XHJcbiAgdGhpcy5fcmVnaXN0cnkuaW50ZXJwb2xhdGUgPSB2YWx1ZTtcclxuICByZXR1cm4gcHJldmlvdXM7XHJcbn07XHJcblxyXG5Db3VudGVycGFydC5wcm90b3R5cGUuZ2V0SW50ZXJwb2xhdGUgPSBmdW5jdGlvbigpIHtcclxuICByZXR1cm4gdGhpcy5fcmVnaXN0cnkuaW50ZXJwb2xhdGU7XHJcbn07XHJcblxyXG5Db3VudGVycGFydC5wcm90b3R5cGUuc2V0S2V5VHJhbnNmb3JtZXIgPSBmdW5jdGlvbih2YWx1ZSkge1xyXG4gIHZhciBwcmV2aW91cyA9IHRoaXMuX3JlZ2lzdHJ5LmtleVRyYW5zZm9ybWVyO1xyXG4gIHRoaXMuX3JlZ2lzdHJ5LmtleVRyYW5zZm9ybWVyID0gdmFsdWU7XHJcbiAgcmV0dXJuIHByZXZpb3VzO1xyXG59O1xyXG5cclxuQ291bnRlcnBhcnQucHJvdG90eXBlLmdldEtleVRyYW5zZm9ybWVyID0gZnVuY3Rpb24oKSB7XHJcbiAgcmV0dXJuIHRoaXMuX3JlZ2lzdHJ5LmtleVRyYW5zZm9ybWVyO1xyXG59O1xyXG5cclxuQ291bnRlcnBhcnQucHJvdG90eXBlLnJlZ2lzdGVyVHJhbnNsYXRpb25zID0gZnVuY3Rpb24obG9jYWxlLCBkYXRhKSB7XHJcbiAgdmFyIHRyYW5zbGF0aW9ucyA9IHt9O1xyXG4gIHRyYW5zbGF0aW9uc1tsb2NhbGVdID0gZGF0YTtcclxuICBleHRlbmQodHJ1ZSwgdGhpcy5fcmVnaXN0cnkudHJhbnNsYXRpb25zLCB0cmFuc2xhdGlvbnMpO1xyXG4gIHJldHVybiB0cmFuc2xhdGlvbnM7XHJcbn07XHJcblxyXG5Db3VudGVycGFydC5wcm90b3R5cGUucmVnaXN0ZXJJbnRlcnBvbGF0aW9ucyA9IGZ1bmN0aW9uKGRhdGEpIHtcclxuICByZXR1cm4gZXh0ZW5kKHRydWUsIHRoaXMuX3JlZ2lzdHJ5LmludGVycG9sYXRpb25zLCBkYXRhKTtcclxufTtcclxuXHJcbkNvdW50ZXJwYXJ0LnByb3RvdHlwZS5vbkxvY2FsZUNoYW5nZSA9XHJcbkNvdW50ZXJwYXJ0LnByb3RvdHlwZS5hZGRMb2NhbGVDaGFuZ2VMaXN0ZW5lciA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7XHJcbiAgdGhpcy5hZGRMaXN0ZW5lcignbG9jYWxlY2hhbmdlJywgY2FsbGJhY2spO1xyXG59O1xyXG5cclxuQ291bnRlcnBhcnQucHJvdG90eXBlLm9mZkxvY2FsZUNoYW5nZSA9XHJcbkNvdW50ZXJwYXJ0LnByb3RvdHlwZS5yZW1vdmVMb2NhbGVDaGFuZ2VMaXN0ZW5lciA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7XHJcbiAgdGhpcy5yZW1vdmVMaXN0ZW5lcignbG9jYWxlY2hhbmdlJywgY2FsbGJhY2spO1xyXG59O1xyXG5cclxuQ291bnRlcnBhcnQucHJvdG90eXBlLm9uVHJhbnNsYXRpb25Ob3RGb3VuZCA9XHJcbkNvdW50ZXJwYXJ0LnByb3RvdHlwZS5hZGRUcmFuc2xhdGlvbk5vdEZvdW5kTGlzdGVuZXIgPSBmdW5jdGlvbihjYWxsYmFjaykge1xyXG4gIHRoaXMuYWRkTGlzdGVuZXIoJ3RyYW5zbGF0aW9ubm90Zm91bmQnLCBjYWxsYmFjayk7XHJcbn07XHJcblxyXG5Db3VudGVycGFydC5wcm90b3R5cGUub2ZmVHJhbnNsYXRpb25Ob3RGb3VuZCA9XHJcbkNvdW50ZXJwYXJ0LnByb3RvdHlwZS5yZW1vdmVUcmFuc2xhdGlvbk5vdEZvdW5kTGlzdGVuZXIgPSBmdW5jdGlvbihjYWxsYmFjaykge1xyXG4gIHRoaXMucmVtb3ZlTGlzdGVuZXIoJ3RyYW5zbGF0aW9ubm90Zm91bmQnLCBjYWxsYmFjayk7XHJcbn07XHJcblxyXG5Db3VudGVycGFydC5wcm90b3R5cGUudHJhbnNsYXRlID0gZnVuY3Rpb24oa2V5LCBvcHRpb25zKSB7XHJcbiAgaWYgKCFpc0FycmF5KGtleSkgJiYgIWlzU3RyaW5nKGtleSkgfHwgIWtleS5sZW5ndGgpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBhcmd1bWVudDoga2V5Jyk7XHJcbiAgfVxyXG5cclxuICBpZiAoaXNTeW1ib2woa2V5KSkge1xyXG4gICAga2V5ID0ga2V5LnN1YnN0cigxKTtcclxuICB9XHJcblxyXG4gIGtleSA9IHRoaXMuX3JlZ2lzdHJ5LmtleVRyYW5zZm9ybWVyKGtleSwgb3B0aW9ucyk7XHJcblxyXG4gIG9wdGlvbnMgPSBleHRlbmQodHJ1ZSwge30sIG9wdGlvbnMpO1xyXG5cclxuICB2YXIgbG9jYWxlID0gb3B0aW9ucy5sb2NhbGUgfHwgdGhpcy5fcmVnaXN0cnkubG9jYWxlO1xyXG4gIGRlbGV0ZSBvcHRpb25zLmxvY2FsZTtcclxuXHJcbiAgdmFyIHNjb3BlID0gb3B0aW9ucy5zY29wZSB8fCB0aGlzLl9yZWdpc3RyeS5zY29wZTtcclxuICBkZWxldGUgb3B0aW9ucy5zY29wZTtcclxuXHJcbiAgdmFyIHNlcGFyYXRvciA9IG9wdGlvbnMuc2VwYXJhdG9yIHx8IHRoaXMuX3JlZ2lzdHJ5LnNlcGFyYXRvcjtcclxuICBkZWxldGUgb3B0aW9ucy5zZXBhcmF0b3I7XHJcblxyXG4gIHZhciBmYWxsYmFja0xvY2FsZXMgPSBbXS5jb25jYXQob3B0aW9ucy5mYWxsYmFja0xvY2FsZSB8fCB0aGlzLl9yZWdpc3RyeS5mYWxsYmFja0xvY2FsZXMpO1xyXG4gIGRlbGV0ZSBvcHRpb25zLmZhbGxiYWNrTG9jYWxlO1xyXG5cclxuICB2YXIga2V5cyA9IHRoaXMuX25vcm1hbGl6ZUtleXMobG9jYWxlLCBzY29wZSwga2V5LCBzZXBhcmF0b3IpO1xyXG5cclxuICB2YXIgZW50cnkgPSBnZXRFbnRyeSh0aGlzLl9yZWdpc3RyeS50cmFuc2xhdGlvbnMsIGtleXMpO1xyXG5cclxuICBpZiAoZW50cnkgPT09IG51bGwgJiYgb3B0aW9ucy5mYWxsYmFjaykge1xyXG4gICAgdGhpcy5lbWl0KCd0cmFuc2xhdGlvbm5vdGZvdW5kJywgbG9jYWxlLCBrZXksIG9wdGlvbnMuZmFsbGJhY2ssIHNjb3BlKTtcclxuICAgIGVudHJ5ID0gdGhpcy5fZmFsbGJhY2sobG9jYWxlLCBzY29wZSwga2V5LCBvcHRpb25zLmZhbGxiYWNrLCBvcHRpb25zKTtcclxuICB9XHJcblxyXG4gIGlmIChlbnRyeSA9PT0gbnVsbCAmJiBmYWxsYmFja0xvY2FsZXMubGVuZ3RoID4gMCAmJiBmYWxsYmFja0xvY2FsZXMuaW5kZXhPZihsb2NhbGUpID09PSAtMSkge1xyXG4gICAgZm9yICh2YXIgaXggaW4gZmFsbGJhY2tMb2NhbGVzKSB7XHJcbiAgICAgIHZhciBmYWxsYmFja0xvY2FsZSA9IGZhbGxiYWNrTG9jYWxlc1tpeF07XHJcbiAgICAgIHZhciBmYWxsYmFja0tleXMgPSB0aGlzLl9ub3JtYWxpemVLZXlzKGZhbGxiYWNrTG9jYWxlLCBzY29wZSwga2V5LCBzZXBhcmF0b3IpO1xyXG4gICAgICBlbnRyeSA9IGdldEVudHJ5KHRoaXMuX3JlZ2lzdHJ5LnRyYW5zbGF0aW9ucywgZmFsbGJhY2tLZXlzKTtcclxuXHJcbiAgICAgIGlmIChlbnRyeSkge1xyXG4gICAgICAgIGxvY2FsZSA9IGZhbGxiYWNrTG9jYWxlO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBpZiAoZW50cnkgPT09IG51bGwpIHtcclxuICAgIGVudHJ5ID0gJ21pc3NpbmcgdHJhbnNsYXRpb246ICcgKyBrZXlzLmpvaW4oc2VwYXJhdG9yKTtcclxuICB9XHJcblxyXG4gIGVudHJ5ID0gdGhpcy5fcGx1cmFsaXplKGxvY2FsZSwgZW50cnksIG9wdGlvbnMuY291bnQpO1xyXG5cclxuICBpZiAodGhpcy5fcmVnaXN0cnkuaW50ZXJwb2xhdGUgIT09IGZhbHNlICYmIG9wdGlvbnMuaW50ZXJwb2xhdGUgIT09IGZhbHNlKSB7XHJcbiAgICBlbnRyeSA9IHRoaXMuX2ludGVycG9sYXRlKGVudHJ5LCBvcHRpb25zKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBlbnRyeTtcclxufTtcclxuXHJcbkNvdW50ZXJwYXJ0LnByb3RvdHlwZS5sb2NhbGl6ZSA9IGZ1bmN0aW9uKG9iamVjdCwgb3B0aW9ucykge1xyXG4gIGlmICghaXNEYXRlKG9iamVjdCkpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignaW52YWxpZCBhcmd1bWVudDogb2JqZWN0IG11c3QgYmUgYSBkYXRlJyk7XHJcbiAgfVxyXG5cclxuICBvcHRpb25zID0gZXh0ZW5kKHRydWUsIHt9LCBvcHRpb25zKTtcclxuXHJcbiAgdmFyIGxvY2FsZSAgPSBvcHRpb25zLmxvY2FsZSAgfHwgdGhpcy5fcmVnaXN0cnkubG9jYWxlO1xyXG4gIHZhciBzY29wZSAgID0gb3B0aW9ucy5zY29wZSAgIHx8IHRyYW5zbGF0aW9uU2NvcGU7XHJcbiAgdmFyIHR5cGUgICAgPSBvcHRpb25zLnR5cGUgICAgfHwgJ2RhdGV0aW1lJztcclxuICB2YXIgZm9ybWF0ICA9IG9wdGlvbnMuZm9ybWF0ICB8fCAnZGVmYXVsdCc7XHJcblxyXG4gIG9wdGlvbnMgPSB7IGxvY2FsZTogbG9jYWxlLCBzY29wZTogc2NvcGUsIGludGVycG9sYXRlOiBmYWxzZSB9O1xyXG4gIGZvcm1hdCAgPSB0aGlzLnRyYW5zbGF0ZShbJ2Zvcm1hdHMnLCB0eXBlLCBmb3JtYXRdLCBleHRlbmQodHJ1ZSwge30sIG9wdGlvbnMpKTtcclxuXHJcbiAgcmV0dXJuIHN0cmZ0aW1lKG9iamVjdCwgZm9ybWF0LCB0aGlzLnRyYW5zbGF0ZSgnbmFtZXMnLCBvcHRpb25zKSk7XHJcbn07XHJcblxyXG5Db3VudGVycGFydC5wcm90b3R5cGUuX3BsdXJhbGl6ZSA9IGZ1bmN0aW9uKGxvY2FsZSwgZW50cnksIGNvdW50KSB7XHJcbiAgaWYgKHR5cGVvZiBlbnRyeSAhPT0gJ29iamVjdCcgfHwgZW50cnkgPT09IG51bGwgfHwgdHlwZW9mIGNvdW50ICE9PSAnbnVtYmVyJykge1xyXG4gICAgcmV0dXJuIGVudHJ5O1xyXG4gIH1cclxuXHJcbiAgdmFyIHBsdXJhbGl6ZUZ1bmMgPSB0aGlzLnRyYW5zbGF0ZSgncGx1cmFsaXplJywgeyBsb2NhbGU6IGxvY2FsZSwgc2NvcGU6IHRyYW5zbGF0aW9uU2NvcGUgfSk7XHJcblxyXG4gIGlmIChPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwocGx1cmFsaXplRnVuYykgIT09ICdbb2JqZWN0IEZ1bmN0aW9uXScpIHtcclxuICAgIHJldHVybiBwbHVyYWxpemVGdW5jO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHBsdXJhbGl6ZUZ1bmMoZW50cnksIGNvdW50KTtcclxufTtcclxuXHJcbkNvdW50ZXJwYXJ0LnByb3RvdHlwZS53aXRoTG9jYWxlID0gZnVuY3Rpb24obG9jYWxlLCBjYWxsYmFjaywgY29udGV4dCkge1xyXG4gIHZhciBwcmV2aW91cyA9IHRoaXMuX3JlZ2lzdHJ5LmxvY2FsZTtcclxuICB0aGlzLl9yZWdpc3RyeS5sb2NhbGUgPSBsb2NhbGU7XHJcbiAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrLmNhbGwoY29udGV4dCk7XHJcbiAgdGhpcy5fcmVnaXN0cnkubG9jYWxlID0gcHJldmlvdXM7XHJcbiAgcmV0dXJuIHJlc3VsdDtcclxufTtcclxuXHJcbkNvdW50ZXJwYXJ0LnByb3RvdHlwZS53aXRoU2NvcGUgPSBmdW5jdGlvbihzY29wZSwgY2FsbGJhY2ssIGNvbnRleHQpIHtcclxuICB2YXIgcHJldmlvdXMgPSB0aGlzLl9yZWdpc3RyeS5zY29wZTtcclxuICB0aGlzLl9yZWdpc3RyeS5zY29wZSA9IHNjb3BlO1xyXG4gIHZhciByZXN1bHQgPSBjYWxsYmFjay5jYWxsKGNvbnRleHQpO1xyXG4gIHRoaXMuX3JlZ2lzdHJ5LnNjb3BlID0gcHJldmlvdXM7XHJcbiAgcmV0dXJuIHJlc3VsdDtcclxufTtcclxuXHJcbkNvdW50ZXJwYXJ0LnByb3RvdHlwZS53aXRoU2VwYXJhdG9yID0gZnVuY3Rpb24oc2VwYXJhdG9yLCBjYWxsYmFjaywgY29udGV4dCkge1xyXG4gIHZhciBwcmV2aW91cyA9IHRoaXMuc2V0U2VwYXJhdG9yKHNlcGFyYXRvcik7XHJcbiAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrLmNhbGwoY29udGV4dCk7XHJcbiAgdGhpcy5zZXRTZXBhcmF0b3IocHJldmlvdXMpO1xyXG4gIHJldHVybiByZXN1bHQ7XHJcbn07XHJcblxyXG5Db3VudGVycGFydC5wcm90b3R5cGUuX25vcm1hbGl6ZUtleXMgPSBmdW5jdGlvbihsb2NhbGUsIHNjb3BlLCBrZXksIHNlcGFyYXRvcikge1xyXG4gIHZhciBrZXlzID0gW107XHJcblxyXG4gIGtleXMgPSBrZXlzLmNvbmNhdCh0aGlzLl9ub3JtYWxpemVLZXkobG9jYWxlLCBzZXBhcmF0b3IpKTtcclxuICBrZXlzID0ga2V5cy5jb25jYXQodGhpcy5fbm9ybWFsaXplS2V5KHNjb3BlLCBzZXBhcmF0b3IpKTtcclxuICBrZXlzID0ga2V5cy5jb25jYXQodGhpcy5fbm9ybWFsaXplS2V5KGtleSwgc2VwYXJhdG9yKSk7XHJcblxyXG4gIHJldHVybiBrZXlzO1xyXG59O1xyXG5cclxuQ291bnRlcnBhcnQucHJvdG90eXBlLl9ub3JtYWxpemVLZXkgPSBmdW5jdGlvbihrZXksIHNlcGFyYXRvcikge1xyXG4gIHRoaXMuX3JlZ2lzdHJ5Lm5vcm1hbGl6ZWRLZXlzW3NlcGFyYXRvcl0gPSB0aGlzLl9yZWdpc3RyeS5ub3JtYWxpemVkS2V5c1tzZXBhcmF0b3JdIHx8IHt9O1xyXG5cclxuICB0aGlzLl9yZWdpc3RyeS5ub3JtYWxpemVkS2V5c1tzZXBhcmF0b3JdW2tleV0gPSB0aGlzLl9yZWdpc3RyeS5ub3JtYWxpemVkS2V5c1tzZXBhcmF0b3JdW2tleV0gfHwgKGZ1bmN0aW9uKGtleSkge1xyXG4gICAgaWYgKGlzQXJyYXkoa2V5KSkge1xyXG4gICAgICB2YXIgbm9ybWFsaXplZEtleUFycmF5ID0ga2V5Lm1hcChmdW5jdGlvbihrKSB7IHJldHVybiB0aGlzLl9ub3JtYWxpemVLZXkoaywgc2VwYXJhdG9yKTsgfS5iaW5kKHRoaXMpKTtcclxuXHJcbiAgICAgIHJldHVybiBbXS5jb25jYXQuYXBwbHkoW10sIG5vcm1hbGl6ZWRLZXlBcnJheSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpZiAodHlwZW9mIGtleSA9PT0gJ3VuZGVmaW5lZCcgfHwga2V5ID09PSBudWxsKSB7XHJcbiAgICAgICAgcmV0dXJuIFtdO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB2YXIga2V5cyA9IGtleS5zcGxpdChzZXBhcmF0b3IpO1xyXG5cclxuICAgICAgZm9yICh2YXIgaSA9IGtleXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcclxuICAgICAgICBpZiAoa2V5c1tpXSA9PT0gJycpIHtcclxuICAgICAgICAgIGtleXMuc3BsaWNlKGksIDEpO1xyXG5cclxuICAgICAgICAgIGlmICh0aGlzLl9yZWdpc3RyeS5rZWVwVHJhaWxpbmdEb3QgPT09IHRydWUgJiYgaSA9PSBrZXlzLmxlbmd0aCkge1xyXG4gICAgICAgICAgICBrZXlzW2tleXMubGVuZ3RoIC0gMV0gKz0gJycgKyBzZXBhcmF0b3I7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4ga2V5cztcclxuICAgIH1cclxuICB9LmJpbmQodGhpcykpKGtleSk7XHJcblxyXG4gIHJldHVybiB0aGlzLl9yZWdpc3RyeS5ub3JtYWxpemVkS2V5c1tzZXBhcmF0b3JdW2tleV07XHJcbn07XHJcblxyXG5Db3VudGVycGFydC5wcm90b3R5cGUuX2ludGVycG9sYXRlID0gZnVuY3Rpb24oZW50cnksIHZhbHVlcykge1xyXG4gIGlmICh0eXBlb2YgZW50cnkgIT09ICdzdHJpbmcnKSB7XHJcbiAgICByZXR1cm4gZW50cnk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gc3ByaW50ZihlbnRyeSwgZXh0ZW5kKHt9LCB0aGlzLl9yZWdpc3RyeS5pbnRlcnBvbGF0aW9ucywgdmFsdWVzKSk7XHJcbn07XHJcblxyXG5Db3VudGVycGFydC5wcm90b3R5cGUuX3Jlc29sdmUgPSBmdW5jdGlvbihsb2NhbGUsIHNjb3BlLCBvYmplY3QsIHN1YmplY3QsIG9wdGlvbnMpIHtcclxuICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTtcclxuXHJcbiAgaWYgKG9wdGlvbnMucmVzb2x2ZSA9PT0gZmFsc2UpIHtcclxuICAgIHJldHVybiBzdWJqZWN0O1xyXG4gIH1cclxuXHJcbiAgdmFyIHJlc3VsdDtcclxuXHJcbiAgaWYgKGlzU3ltYm9sKHN1YmplY3QpKSB7XHJcbiAgICByZXN1bHQgPSB0aGlzLnRyYW5zbGF0ZShzdWJqZWN0LCBleHRlbmQoe30sIG9wdGlvbnMsIHsgbG9jYWxlOiBsb2NhbGUsIHNjb3BlOiBzY29wZSB9KSk7XHJcbiAgfSBlbHNlIGlmIChpc0Z1bmN0aW9uKHN1YmplY3QpKSB7XHJcbiAgICB2YXIgZGF0ZU9yVGltZTtcclxuXHJcbiAgICBpZiAob3B0aW9ucy5vYmplY3QpIHtcclxuICAgICAgZGF0ZU9yVGltZSA9IG9wdGlvbnMub2JqZWN0O1xyXG4gICAgICBkZWxldGUgb3B0aW9ucy5vYmplY3Q7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBkYXRlT3JUaW1lID0gb2JqZWN0O1xyXG4gICAgfVxyXG5cclxuICAgIHJlc3VsdCA9IHRoaXMuX3Jlc29sdmUobG9jYWxlLCBzY29wZSwgb2JqZWN0LCBzdWJqZWN0KGRhdGVPclRpbWUsIG9wdGlvbnMpKTtcclxuICB9IGVsc2Uge1xyXG4gICAgcmVzdWx0ID0gc3ViamVjdDtcclxuICB9XHJcblxyXG4gIHJldHVybiAvXm1pc3NpbmcgdHJhbnNsYXRpb246Ly50ZXN0KHJlc3VsdCkgPyBudWxsIDogcmVzdWx0O1xyXG59O1xyXG5cclxuQ291bnRlcnBhcnQucHJvdG90eXBlLl9mYWxsYmFjayA9IGZ1bmN0aW9uKGxvY2FsZSwgc2NvcGUsIG9iamVjdCwgc3ViamVjdCwgb3B0aW9ucykge1xyXG4gIG9wdGlvbnMgPSBleGNlcHQob3B0aW9ucywgJ2ZhbGxiYWNrJyk7XHJcblxyXG4gIGlmIChpc0FycmF5KHN1YmplY3QpKSB7XHJcbiAgICBmb3IgKHZhciBpID0gMCwgaWkgPSBzdWJqZWN0Lmxlbmd0aDsgaSA8IGlpOyBpKyspIHtcclxuICAgICAgdmFyIHJlc3VsdCA9IHRoaXMuX3Jlc29sdmUobG9jYWxlLCBzY29wZSwgb2JqZWN0LCBzdWJqZWN0W2ldLCBvcHRpb25zKTtcclxuXHJcbiAgICAgIGlmIChyZXN1bHQpIHtcclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG51bGw7XHJcbiAgfSBlbHNlIHtcclxuICAgIHJldHVybiB0aGlzLl9yZXNvbHZlKGxvY2FsZSwgc2NvcGUsIG9iamVjdCwgc3ViamVjdCwgb3B0aW9ucyk7XHJcbiAgfVxyXG59O1xyXG5cclxudmFyIGluc3RhbmNlID0gbmV3IENvdW50ZXJwYXJ0KCk7XHJcblxyXG5mdW5jdGlvbiB0cmFuc2xhdGUoKSB7XHJcbiAgcmV0dXJuIGluc3RhbmNlLnRyYW5zbGF0ZS5hcHBseShpbnN0YW5jZSwgYXJndW1lbnRzKTtcclxufVxyXG5cclxuZXh0ZW5kKHRyYW5zbGF0ZSwgaW5zdGFuY2UsIHtcclxuICBJbnN0YW5jZTogQ291bnRlcnBhcnQsXHJcbiAgVHJhbnNsYXRvcjogQ291bnRlcnBhcnRcclxufSk7XHJcblxyXG5tb2R1bGUuZXhwb3J0cyA9IHRyYW5zbGF0ZTtcclxuIl19